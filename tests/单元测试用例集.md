# TrayPrinterApp - 单元测试用例集（统一PDF架构版）

## 目录
1. [测试概览](#1-测试概览)
2. [核心组件测试](#2-核心组件测试)
3. [统一打印管理测试](#3-统一打印管理测试)
4. [文件转换器测试](#4-文件转换器测试)
5. [PDF打印引擎测试](#5-pdf打印引擎测试)
6. [配置管理测试](#6-配置管理测试)
7. [文件夹监视测试](#7-文件夹监视测试)
8. [集成测试](#8-集成测试)

## 1. 测试概览

### 测试环境说明 🆕
- **测试框架**：xUnit 2.6.6
- **目标框架**：.NET 8
- **Mock框架**：Moq 4.20.x
- **断言库**：FluentAssertions 6.12.x
- **测试工具**：Visual Studio 2022 Test Explorer / dotnet test
- **覆盖率工具**：coverlet.collector

### 测试统计 🆕
```
测试总数: 104+
├── 核心组件测试: 20个
├── 统一打印系统测试: 35个
│   ├── UnifiedPrintManager: 15个
│   ├── 文件转换器: 12个
│   └── PDF打印引擎: 8个
├── 配置管理测试: 15个
├── 文件夹监视测试: 20个
├── 文件操作测试: 8个
├── 任务历史测试: 6个
└── 集成测试: 10个

代码覆盖率: 85%+ (核心组件)
```

## 2. 核心组件测试

### TC-CORE-001：应用程序核心启动
**测试目的**：验证AppCore能正确初始化所有核心组件
**测试文件**：`tests/Core/AppCoreTests.cs`
**测试步骤**：
1. 创建AppCore实例
2. 调用Start()方法启动应用
3. 验证所有服务正确注册和启动
**预期结果**：
- 文件监视服务启动成功
- 统一打印管理器初始化成功
- 配置服务加载成功

### TC-CORE-002：日志系统测试 🆕
**测试目的**：验证FileLogger正确写入和管理日志文件
**测试文件**：`tests/Core/FileLoggerTests.cs`
**前置条件**：临时测试目录`C:\TestLogs`
**测试步骤**：
1. 创建FileLogger实例，指定测试日志目录
2. 记录不同级别日志（Debug, Info, Warning, Error）
3. 验证日志文件创建和内容
**预期结果**：
- 日志文件按日期创建（app_yyyyMMdd.log）
- 日志级别过滤正确
- 日志格式包含时间戳、级别和消息

### TC-CORE-003：配置热更新测试 🆕
**测试目的**：验证配置文件变化时应用程序能正确响应
**测试文件**：`tests/Core/ConfigurationHotUpdateTests.cs`
**测试步骤**：
1. 启动应用程序并加载初始配置
2. 修改配置文件中的监控路径
3. 验证文件监视服务使用新路径
**预期结果**：
- 配置变化被检测到
- 相关组件重新配置
- 无需重启应用程序

## 3. 统一打印管理测试 🆕

### TC-UPM-001：统一打印管理器初始化
**测试目的**：验证UnifiedPrintManager正确初始化转换器和打印引擎
**测试文件**：`tests/Printing/UnifiedPrintManagerTests.cs`
**测试步骤**：
1. 使用Mock依赖创建UnifiedPrintManager实例
2. 验证ConverterFactory正确注册
3. 验证PdfiumPrintEngine正确配置
**预期结果**：
- 所有转换器类型正确注册
- 打印引擎初始化成功
- 依赖注入配置正确

### TC-UPM-002：混合文件类型批量打印 🆕
**测试目的**：验证统一打印管理器处理多种文件类型的批量任务
**测试数据**：
```csharp
var files = new[]
{
    "test.pdf",      // 直接处理
    "document.docx", // Word转换
    "image.jpg"      // 图片转换
};
```
**测试步骤**：
1. 创建包含PDF、Word、图片的混合文件列表
2. 调用PrintFilesAsync()方法
3. 验证每种文件类型使用正确的转换器
**预期结果**：
- PDF文件直接发送到打印引擎
- Word文件先转换为PDF再打印
- 图片文件先转换为PDF再打印
- 所有文件最终统一使用PDF打印引擎

### TC-UPM-003：打印错误处理和重试 🆕
**测试目的**：验证打印失败时的错误处理和重试机制
**测试步骤**：
1. Mock打印引擎返回失败结果
2. 调用打印方法并捕获异常
3. 验证错误记录和重试逻辑
**预期结果**：
- 打印失败被正确捕获
- 错误信息记录到日志
- 根据配置决定是否重试

## 4. 文件转换器测试 🆕

### TC-CONV-001：PDF转换器（直接处理）
**测试目的**：验证PdfConverter正确处理PDF文件
**测试文件**：`tests/Printing/FileConvertersTests.cs`
**测试步骤**：
1. 创建PdfConverter实例
2. 传入测试PDF文件路径
3. 调用ConvertToPdfAsync()方法
**预期结果**：
- 返回原始PDF文件路径（无需转换）
- 验证PDF文件完整性
- 无临时文件产生

### TC-CONV-002：Word转PDF转换 🆕
**测试目的**：验证WordToPdfConverter正确转换Word文档为PDF
**前置条件**：系统已安装Microsoft Office
**测试步骤**：
1. 创建测试Word文档（包含文本、图片、表格）
2. 使用WordToPdfConverter转换为PDF
3. 验证转换后的PDF文件
**预期结果**：
- 转换后PDF文件存在且可读
- 页面数量与原Word文档匹配
- 格式和布局基本保持一致
- Office进程正确释放

### TC-CONV-003：图片转PDF转换 🆕
**测试目的**：验证ImageToPdfConverter处理各种图片格式
**测试数据**：
```csharp
var imageFiles = new[]
{
    "test.jpg",
    "test.png", 
    "test.bmp"
};
```
**测试步骤**：
1. 创建不同格式的测试图片
2. 使用ImageToPdfConverter逐个转换
3. 验证生成的PDF文件
**预期结果**：
- 支持JPG、PNG、BMP格式
- 转换后PDF包含原图片内容
- 页面尺寸适配图片比例
- 图片质量保持合理水平

### TC-CONV-004：转换器工厂模式测试 🆕
**测试目的**：验证ConverterFactory正确返回对应的转换器
**测试步骤**：
1. 创建ConverterFactory实例
2. 测试不同文件扩展名获取转换器
3. 验证返回的转换器类型
**预期结果**：
```csharp
factory.GetConverter(".pdf")  -> PdfConverter
factory.GetConverter(".docx") -> WordToPdfConverter
factory.GetConverter(".jpg")  -> ImageToPdfConverter
factory.GetConverter(".xyz")  -> NotSupportedException
```

## 5. PDF打印引擎测试 🆕

### TC-PDF-001：PdfiumViewer PDF加载测试
**测试目的**：验证PdfiumPrintEngine正确加载PDF文档
**测试文件**：`tests/Printing/PdfPrintEngineTests.cs`
**测试步骤**：
1. 创建PdfiumPrintEngine实例
2. 使用测试PDF文件调用LoadDocument()
3. 验证文档加载状态和页面信息
**预期结果**：
- PDF文档成功加载
- 页面数量正确
- 文档元数据可访问
- 内存使用合理

### TC-PDF-002：PDF打印配置测试 🆕
**测试目的**：验证PDF打印引擎正确应用打印设置
**测试步骤**：
1. 配置打印参数（份数、方向、质量）
2. 创建打印文档对象
3. 验证PrinterSettings配置
**预期结果**：
- 打印份数设置正确
- 页面方向配置正确
- 打印质量参数生效
- 打印机名称匹配

### TC-PDF-003：大文件PDF打印性能测试 🆕
**测试目的**：验证PDF打印引擎处理大文件的性能
**测试条件**：
- 测试PDF文件大小: 10MB+
- 页面数量: 50页+
**测试步骤**：
1. 使用大型PDF文件进行打印测试
2. 监控内存使用和处理时间
3. 验证打印完成状态
**预期结果**：
- 内存使用不超过500MB
- 处理时间在合理范围内
- 无内存泄漏
- 打印输出完整

## 6. 配置管理测试

### TC-CFG-001：新配置结构加载测试 🆕
**测试目的**：验证配置服务正确加载统一PDF架构的配置
**测试数据**：
```json
{
  "PrintSettings": {
    "DefaultCopies": 2,
    "DefaultOrientation": "Landscape"
  },
  "TaskHistorySettings": {
    "MaxRecords": 100,
    "EnableHistory": true
  }
}
```
**测试步骤**：
1. 创建包含新配置节的测试配置文件
2. 使用JsonConfigurationService加载配置
3. 验证各配置节正确解析
**预期结果**：
- PrintSettings正确加载
- TaskHistorySettings正确解析
- 向后兼容原有配置结构

### TC-CFG-002：用户数据路径管理测试 🆕
**测试目的**：验证UserDataPath正确管理用户数据目录
**测试文件**：`tests/Configuration/UserDataPathTests.cs`
**测试步骤**：
1. 获取用户数据路径
2. 创建必要的子目录（logs、config、history）
3. 验证路径权限和可访问性
**预期结果**：
- 用户数据目录正确创建
- 路径符合Windows标准
- 具有读写权限

## 7. 文件夹监视测试

### TC-MON-001：增强的文件类型过滤 🆕
**测试目的**：验证文件监视器正确过滤新增的文件类型
**测试步骤**：
1. 配置监视器监听`.pdf, .docx, .jpg, .png, .bmp`
2. 在测试目录创建各种文件类型
3. 验证事件触发和文件过滤
**预期结果**：
- 支持的文件类型正确触发事件
- 不支持的文件类型被过滤
- 文件完整性检查正常

### TC-MON-002：批量收集超时优化测试 🆕
**测试目的**：验证改进的批量收集算法
**测试步骤**：
1. 设置3秒批量收集超时
2. 在1秒内连续创建5个文件
3. 在第2秒时再创建2个文件
4. 验证批量事件触发时机
**预期结果**：
- 事件在最后一个文件创建后3秒触发
- 批量包含所有7个文件
- 时间窗口正确重置

## 8. 集成测试

### TC-INT-001：端到端打印流程测试 🆕
**测试目的**：验证从文件接收到打印完成的完整流程
**测试文件**：`tests/Integration/IntegrationTests.cs`
**测试场景**：
1. 创建混合类型测试文件（PDF + Word + 图片）
2. 复制到监控目录触发批量处理
3. 选择测试打印机
4. 验证转换和打印结果
**预期结果**：
- 所有文件正确转换为PDF
- 统一使用PDF引擎打印
- 原文件正确归档
- 任务历史正确记录

### TC-INT-002：并发处理压力测试 🆕
**测试目的**：验证系统在高并发情况下的稳定性
**测试步骤**：
1. 同时创建50个不同类型的文件
2. 模拟多个打印任务并发执行
3. 监控系统资源使用
4. 验证所有任务正确完成
**预期结果**：
- 无死锁和竞态条件
- 内存使用合理
- 所有文件正确处理
- 错误处理机制正常

### TC-INT-003：异常恢复测试 🆕
**测试目的**：验证系统在异常情况下的恢复能力
**测试场景**：
- Office进程异常退出
- 磁盘空间不足
- 打印机离线
- 配置文件损坏
**测试步骤**：
1. 模拟各种异常情况
2. 验证错误检测和处理
3. 测试系统自动恢复
**预期结果**：
- 异常被正确捕获和记录
- 系统能优雅处理错误
- 部分功能失效不影响整体系统
- 恢复后功能正常

## 🧪 测试执行指南

### 运行全部测试
```bash
# 运行所有测试
dotnet test tests/TrayApp.Tests.csproj

# 生成覆盖率报告
dotnet test tests/TrayApp.Tests.csproj --collect:"XPlat Code Coverage"
```

### 分类运行测试 🆕
```bash
# 仅运行打印系统测试
dotnet test --filter "FullyQualifiedName~Printing"

# 仅运行核心组件测试
dotnet test --filter "FullyQualifiedName~Core"

# 仅运行集成测试
dotnet test --filter "Category=Integration"
```

### 安全测试脚本 🆕
```bash
# 使用项目提供的安全测试脚本
powershell -File run-safe-tests.ps1
```

## 📊 测试质量指标

### 代码覆盖率目标 🆕
```
整体目标: 85%+
├── 核心组件: 95%+
├── 统一打印系统: 90%+
├── 文件转换器: 88%+
├── PDF打印引擎: 85%+
├── 配置管理: 90%+
└── UI组件: 70%+
```

### 性能基准 🆕
- **单元测试执行时间**: < 10秒
- **集成测试执行时间**: < 30秒
- **内存使用峰值**: < 100MB
- **文件转换测试**: < 5秒/文件

---

**🎯 测试策略**: 统一PDF打印架构的测试重点关注文件转换的正确性和PDF打印引擎的稳定性，同时确保向后兼容性和新功能的可靠性。所有测试都设计有超时机制，避免测试挂起影响CI/CD流程。