# 打印店自动打印系统 - 单元测试用例集

## 目录
1. [配置服务测试](#1-配置服务测试)
2. [文件夹监视测试](#2-文件夹监视测试)
3. [打印管理测试](#3-打印管理测试)
4. [文件操作测试](#4-文件操作测试)
5. [任务历史测试](#5-任务历史测试)

## 测试环境说明
- **测试框架**：xUnit 2.4.1
- **目标框架**：.NET Framework 4.8
- **测试工具**：Visual Studio 2022 Test Explorer
- **测试文件位置**：`tests/TestFiles`（包含各类测试文件）

## 1. 配置服务测试

### TC-CFG-001：加载配置文件
**测试目的**：验证配置服务能否正确加载appsettings.json
**前置条件**：测试目录下存在`test_config.json`
**测试步骤**：
1. 创建JsonConfigurationService实例，指定测试配置文件路径
2. 调用GetSettings()方法获取配置
**预期结果**：
- 返回的AppSettings对象不为null
- Monitoring.WatchPath等于配置文件中的值
- FileTypeAssociations包含至少3种文件类型配置

### TC-CFG-002：打印机过滤测试
**测试目的**：验证配置服务能否正确过滤隐藏打印机
**测试数据**：
```json
"PrinterManagement": {
  "HiddenPrinters": ["TestPrinter1", "TestPrinter2"]
}
```
**测试步骤**：
1. 创建JsonConfigurationService实例，加载测试配置
2. 调用GetHiddenPrinters()方法
**预期结果**：
- 返回的列表包含"TestPrinter1"和"TestPrinter2"
- 列表不包含其他打印机名称

### TC-CFG-003：文件类型映射测试
**测试目的**：验证配置服务能否正确获取文件类型关联
**测试步骤**：
1. 创建JsonConfigurationService实例，加载默认配置
2. 分别调用GetFileTypeAssociation(".pdf")和GetFileTypeAssociation(".txt")
**预期结果**：
- .pdf返回非null的FileTypeAssociation对象
- .txt返回null（配置中未定义）

## 2. 文件夹监视测试

### TC-MON-001：单个文件监视
**测试目的**：验证文件夹监视能正确检测单个新文件
**前置条件**：
- 创建临时测试目录`C:\TestWatchFolder`
- 清理目录中所有文件
**测试步骤**：
1. 创建FileSystemWatcherMonitor实例，设置监视目录和3秒超时
2. 在测试目录中创建测试文件`test.pdf`
3. 等待5秒，检查是否触发FilesBatchReady事件
**预期结果**：
- 事件被触发，FileBatchEventArgs.FilePaths包含`test.pdf`路径
- 文件路径正确指向测试目录中的文件

### TC-MON-002：批量文件监视
**测试目的**：验证3秒内新增的多个文件能被合并为一个批次
**测试步骤**：
1. 创建FileSystemWatcherMonitor实例，设置监视目录和3秒超时
2. 在测试目录中创建`file1.pdf`
3. 等待1秒后创建`file2.pdf`
4. 等待1秒后创建`file3.pdf`
5. 等待5秒，检查事件参数中的文件列表
**预期结果**：
- 事件只触发一次
- FilePaths包含3个文件路径
- 文件顺序与创建顺序一致

### TC-MON-003：文件类型过滤
**测试目的**：验证监视模块能过滤非目标文件类型
**测试步骤**：
1. 创建FileSystemWatcherMonitor实例，设置监视目录、3秒超时，仅监视[".pdf"]
2. 在测试目录中创建`test.pdf`和`test.txt`
3. 等待5秒，检查事件参数中的文件列表
**预期结果**：
- FilePaths仅包含`test.pdf`
- `test.txt`被过滤，未包含在列表中

### TC-MON-004：文件锁定处理
**测试目的**：验证监视模块能处理文件未完全写入的情况
**测试步骤**：
1. 创建FileSystemWatcherMonitor实例，设置监视目录和3秒超时
2. 创建测试文件`locked.pdf`，保持文件流打开（模拟微信正在传输）
3. 等待5秒，检查事件触发情况
**预期结果**：
- 前3秒内不触发事件（文件被锁定）
- 文件关闭后3秒内触发事件
- FilePaths包含`locked.pdf`路径

## 3. 打印管理测试

### TC-PRT-001：可用打印机获取
**测试目的**：验证打印管理能正确返回过滤后的打印机列表
**前置条件**：
- 系统已安装至少2台打印机
- 配置文件HiddenPrinters包含其中一台
**测试步骤**：
1. 创建ExternalPrintManager实例
2. 调用GetAvailablePrinters()方法
**预期结果**：
- 返回的列表不包含HiddenPrinters中的打印机
- 列表包含至少1台可用打印机
- 打印机名称与系统中的一致

### TC-PRT-002：PDF页码计算
**测试目的**：验证打印管理能正确计算PDF文件页码
**测试步骤**：
1. 创建ExternalPrintManager实例
2. 获取测试PDF文件路径（已知包含5页内容）
3. 调用CalculateTotalPages([testPdfPath])
**预期结果**：
- 返回值为5
- 无异常抛出

### TC-PRT-003：打印程序调用测试
**测试目的**：验证打印管理能正确调用外部打印程序
**前置条件**：已安装Adobe Acrobat
**测试步骤**：
1. 创建ExternalPrintManager实例
2. 获取测试PDF文件路径和系统中的可用打印机名称
3. 使用反射调用PrintFile()方法（传入测试文件和打印机名称）
**预期结果**：
- 无异常抛出
- 打印队列中出现对应打印任务
- 打印程序进程自动退出（无残留）

## 4. 文件操作测试

### TC-FOP-001：时间戳目录创建
**测试目的**：验证文件操作模块能创建正确格式的时间戳目录
**测试步骤**：
1. 创建TimestampFileOperator实例
2. 指定基础目录`C:\TestBaseDir`
3. 调用MoveFilesToTimestampDirectory()，传入空文件列表
**预期结果**：
- 在`C:\TestBaseDir`下创建格式为`yyyyMMddHHmmss`的目录
- 目录名称中的时间接近当前系统时间（误差<5秒）
- 目录创建成功且可访问

### TC-FOP-002：文件移动测试
**测试目的**：验证文件操作模块能正确移动文件到时间戳目录
**前置条件**：
- 创建测试文件`test.pdf`到`C:\SourceDir`
**测试步骤**：
1. 创建TimestampFileOperator实例
2. 调用MoveFilesToTimestampDirectory([`C:\SourceDir\test.pdf`], `C:\TargetBaseDir`)
3. 检查目标目录中的文件
**预期结果**：
- 源文件被移动（源目录中不再存在）
- 目标时间戳目录中存在`test.pdf`
- 文件内容未损坏（对比移动前后的MD5哈希）

### TC-FOP-003：重复文件名处理
**测试目的**：验证文件操作模块能处理目标目录中已存在同名文件的情况
**测试步骤**：
1. 创建TimestampFileOperator实例
2. 在目标基础目录下手动创建时间戳目录（使用当前时间）
3. 在该目录中创建`test.pdf`（内容任意）
4. 调用MoveFilesToTimestampDirectory([`C:\SourceDir\test.pdf`], 目标基础目录)
**预期结果**：
- 源文件被移动到时间戳目录
- 目标文件被重命名为`test_1.pdf`
- 原`test.pdf`和新`test_1.pdf`同时存在于目录中

## 5. 任务历史测试

### TC-TH-001：添加任务记录
**测试目的**：验证任务历史能正确添加新记录
**测试步骤**：
1. 创建TaskHistoryManager实例，设置最大记录数5
2. 创建PrintTaskRecord对象（FileCount=3, TotalPages=10, PrinterName="TestPrinter"）
3. 调用AddTaskRecord()方法
4. 获取最近任务记录
**预期结果**：
- GetRecentTasks(1)返回包含新增记录的列表
- 记录中的Timestamp接近当前时间
- FileCount=3，TotalPages=10，PrinterName="TestPrinter"

### TC-TH-002：历史记录修剪
**测试目的**：验证历史记录超过最大数量时能自动修剪
**测试步骤**：
1. 创建TaskHistoryManager实例，设置最大记录数3
2. 添加4条不同的任务记录
3. 获取所有历史记录
**预期结果**：
- 记录总数为3
- 最早添加的记录被删除
- 剩余记录按时间戳降序排列（最新的在前）

### TC-TH-003：历史记录持久化
**测试目的**：验证任务历史能正确保存到文件并在重启后加载
**测试步骤**：
1. 创建TaskHistoryManager实例，设置存储路径`test_history.json`
2. 添加2条任务记录
3. 销毁实例后创建新的TaskHistoryManager实例，使用相同存储路径
4. 获取最近任务记录
**预期结果**：
- 新实例加载的记录数=2
- 记录内容与添加时一致
- 时间戳保持不变