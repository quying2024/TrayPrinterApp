# TrayPrinterApp MSI ????????.NET 8 ????

??????????PDF?????TrayPrinterApp??MSI??????.NET 8??????

## ?? ????
1. ?????MSI??????x64???
2. ???.NET 8?????????????
3. ????PDF???????????
4. ????????????
5. ??Windows????????

## ?? ????

### ????
- Visual Studio 2022???Microsoft Visual Studio Installer Projects???
- .NET 8 SDK
- WiX Toolset 3.11+????????MSI???
- ?????????????????

### 1. ????????? ??
```powershell
# ?????x64?????.NET 8????
dotnet publish src/TrayApp.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -o ./publish/win-x64

# ??????
dir ./publish/win-x64
```

**???????????**?
```
publish/win-x64/
??? TrayApp.exe                           # ???
??? TrayApp.dll, *.dll                   # .NET???
??? runtimes/                            # .NET??????
??? config/
?   ??? appsettings.json                 # ????
??? PdfiumViewer.Native.x86_64.dll      # PDF???? ??
??? Microsoft.Office.Interop.Word.dll   # Word???? ??
??? README.md, LICENSE                   # ????
```

## ??? ????Visual Studio Installer Projects??????

### 2. ??Visual Studio??
1. ??Visual Studio 2022
2. ?? ? ???? ? ??"Microsoft Visual Studio Installer Projects"
3. ?????????VS?

### 3. ??Setup??
1. ???? ? ?? ? ???? ? ??"Setup Project"
2. ?????`TrayPrinterApp.Setup`
3. **??**???????? `x64`

### 4. ??File System ??
1. ??Setup?? ? ?? ? ????
2. ??Application Folder?
   ```
   Application Folder???
   - DefaultLocation: [ProgramFiles64Folder]\TrayPrinterApp
   - AlwaysCreate: True
   ```

3. ???????
   - ??Application Folder ? ?? ? ??? ? ????`publish/win-x64`??
   - **????runtimes???**?.NET 8????

4. ????????
   - ?????`config`
   - ??`config/appsettings.json`?????
   - **??????**?`Permanent=True`???????????

### 5. ??????
1. ?Application Folder???`TrayApp.exe`
2. ?? ? Create Shortcut to TrayApp.exe
3. ????????"TrayPrinterApp"
4. ????????
   - `User's Desktop`????????
   - `User's Programs Menu`??????

### 6. ?????? ??
```
Setup?????
??? Author: TrayPrinterApp Team
??? Description: ??PDF???????
??? Manufacturer: Your Company Name  
??? ProductName: TrayPrinterApp
??? Version: 2.0.0???PDF?????
??? TargetPlatform: x64
??? InstallAllUsers: True
```

### 7. ???????? ??
1. ??Setup?? ? ?? ? ????
2. ???????
   ```
   .NET Framework????????.NET 8????
   ????????
   ??? ??: Windows?? >= 10.0
   ??? ??: ??Windows 10?????
   ??? InstallUrl: ????
   ```

### 8. ??MSI
1. ??Setup?? ? ??
2. ???MSI???`TrayPrinterApp.Setup\bin\Release\TrayPrinterApp.Setup.msi`

## ?? ????WiX Toolset????????

### ??WiX???? ??
```xml
<!-- TrayPrinterApp.wxs -->
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" 
           Name="TrayPrinterApp" 
           Language="1033" 
           Version="2.0.0" 
           Manufacturer="Your Company" 
           UpgradeCode="PUT-GUID-HERE">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perMachine"
             Platform="x64" />

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    
    <MediaTemplate EmbedCab="yes" />

    <!-- ???? -->
    <Feature Id="ProductFeature" Title="TrayPrinterApp" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ConfigComponents" />
    </Feature>

    <!-- ???? -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="TrayPrinterApp">
          <Directory Id="ConfigFolder" Name="config" />
        </Directory>
      </Directory>
      
      <!-- ???? -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="TrayPrinterApp"/>
      </Directory>
      
      <!-- ?? -->
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <!-- ????? -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="PUT-GUID-HERE" Win64="yes">
        <File Id="TrayAppExe" 
              Source="$(var.PublishDir)\TrayApp.exe" 
              KeyPath="yes" />
      </Component>
      
      <!-- ???????? -->
      <Component Id="RuntimeFiles" Guid="PUT-GUID-HERE" Win64="yes">
        <File Source="$(var.PublishDir)\*.dll" />
        <File Source="$(var.PublishDir)\runtimes\**\*" />
      </Component>
    </ComponentGroup>

    <!-- ?????? -->
    <ComponentGroup Id="ConfigComponents" Directory="ConfigFolder">
      <Component Id="ConfigFile" Guid="PUT-GUID-HERE" Win64="yes">
        <File Id="AppSettings" 
              Source="$(var.PublishDir)\config\appsettings.json"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- ???? -->
    <Component Id="ApplicationShortcut" Directory="ApplicationProgramsFolder" Guid="PUT-GUID-HERE" Win64="yes">
      <Shortcut Id="ApplicationStartMenuShortcut"
                Name="TrayPrinterApp"
                Description="??PDF???????"
                Target="[#TrayAppExe]"
                WorkingDirectory="INSTALLFOLDER"/>
      <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
      <RegistryValue Root="HKCU" Key="Software\TrayPrinterApp" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
    </Component>

  </Product>
</Wix>
```

### ??WiX??
```bash
# ??WiX???
candle -arch x64 TrayPrinterApp.wxs -dPublishDir=./publish/win-x64

# ????MSI
light -out TrayPrinterApp.msi TrayPrinterApp.wixobj
```

## ?? ??????

### 1. ?????? ??
```xml
<!-- ?WiX??? -->
<Property Id="ARPNOMODIFY" Value="1" />
<Property Id="ARPNOREPAIR" Value="1" />
<Property Id="ARPHELPLINK" Value="https://github.com/quying2024/TrayPrinterApp" />
```

### 2. ??????
```xml
<!-- ?????????? -->
<Component Id="AutoStartRegistry" Directory="INSTALLFOLDER" Guid="PUT-GUID-HERE" Win64="yes">
  <RegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run">
    <RegistryValue Name="TrayPrinterApp" 
                   Type="string" 
                   Value="[INSTALLFOLDER]TrayApp.exe" />
  </RegistryKey>
</Component>
```

### 3. ??Windows????? ??
```xml
<!-- ???????? -->
<Component Id="FirewallException" Directory="INSTALLFOLDER" Guid="PUT-GUID-HERE" Win64="yes">
  <fire:FirewallException Id="TrayAppFirewall"
                          Name="TrayPrinterApp"
                          Program="[#TrayAppExe]"
                          Scope="localSubnet" />
</Component>
```

## ? ?????

### 1. ???????
- [ ] ???????
- [ ] ??????????????
- [ ] ??????????
- [ ] Word?PDF?????? ??
- [ ] ???PDF?????? ??
- [ ] PDF?????? ??
- [ ] ????????
- [ ] ??????????

### 2. ?????
- Windows 10 1909+ (x64)
- Windows 11 (x64)
- ?Office??????????Office?
- ?Office???Word???????

### 3. ???? ??
```bash
# ???v1.x???v2.0
# ??????????
# ???????
```

## ?? ????????

### ??signtool??MSI
```bash
# ????????
signtool sign /f "certificate.p12" /p "password" /t http://timestamp.comodoca.com /d "TrayPrinterApp" TrayPrinterApp.msi
```

## ?? ?????? ??

### ???????
- [ ] MSI?????????100-200MB??.NET????
- [ ] ???????.NET 8?????
- [ ] PDF????????
- [ ] Word????????
- [ ] ????????
- [ ] ??????

### ????
- [ ] ????Windows???????
- [ ] ????????.NET??
- [ ] ??Office??????
- [ ] ?????????

---

## ?? ?????? ??

### PowerShell?????
```powershell
# deploy-trayprinter.ps1
param(
    [string]$TargetPath = "C:\Program Files\TrayPrinterApp",
    [bool]$CreateDesktopShortcut = $true,
    [bool]$StartWithWindows = $true
)

# ??.NET 8???
$dotnetVersion = & dotnet --version 2>$null
if (-not $dotnetVersion -or -not $dotnetVersion.StartsWith("8.")) {
    Write-Host "????.NET 8???..." -ForegroundColor Yellow
    # ?????.NET 8
}

# ??????
Copy-Item -Path ".\publish\win-x64\*" -Destination $TargetPath -Recurse -Force

# ??????
if ($CreateDesktopShortcut) {
    $shell = New-Object -ComObject WScript.Shell
    $shortcut = $shell.CreateShortcut("$env:USERPROFILE\Desktop\TrayPrinterApp.lnk")
    $shortcut.TargetPath = "$TargetPath\TrayApp.exe"
    $shortcut.Save()
}

Write-Host "TrayPrinterApp??PDF?????????" -ForegroundColor Green
```

**?? ????**: ??PDF?????MSI???????????????????????????????.NET 8????PDF??????????????????????????????????????
