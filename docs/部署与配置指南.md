# TrayPrinterApp - 部署与配置指南（统一PDF架构版）

## 目录
1. [环境要求](#1-环境要求)
2. [安装步骤](#2-安装步骤)
3. [配置文件详解](#3-配置文件详解)
4. [日常操作指南](#4-日常操作指南)
5. [系统维护](#5-系统维护)

## 1. 环境要求

### 硬件要求
- 处理器：Intel Core i3 或同等性能处理器
- 内存：4GB RAM（推荐8GB，用于大文件转换）
- 硬盘空间：至少500MB可用空间（含.NET运行时、Office组件和日志空间）
- 网络：无特殊要求（本地打印机需正确连接）

### 软件要求
- **操作系统**：Windows 10/11（64位，推荐Windows 10 1909+）
- **.NET Runtime**：.NET 8 Desktop Runtime 🆕
- **Office组件**：Microsoft Office 2016+（Word转换功能需要）🆕
- **PDF支持**：通过PdfiumViewer自动提供，无需Adobe软件 🆕

### 依赖组件安装 🆕
1. **.NET 8 Runtime**：
   ```bash
   # 检查是否已安装
   dotnet --version
   
   # 如未安装，从官网下载：
   # https://dotnet.microsoft.com/download/dotnet/8.0
   ```

2. **Microsoft Office**：
   - 必须安装完整版Office（包含Word组件）
   - Office 365、Office 2019、Office 2021均可
   - 确保Word程序能正常启动

3. **Visual C++ 运行库**：
   - PdfiumViewer依赖，通常已随系统安装
   - 如有问题，安装Microsoft Visual C++ Redistributable

## 2. 安装步骤

### 2.1 程序部署 🆕
1. **编译发布程序**：
   ```bash
   # 发布为自包含应用（推荐）
   dotnet publish src/TrayApp.csproj -c Release -r win-x64 --self-contained -o ./publish
   
   # 或发布为依赖框架的应用
   dotnet publish src/TrayApp.csproj -c Release -o ./publish
   ```

2. **目标目录部署**：
   将 `./publish` 文件夹复制到目标目录（建议路径：`C:\Program Files\TrayPrinterApp`）

3. **确认部署结构** 🆕：
   ```
   TrayPrinterApp/
   ├── TrayApp.exe                    # 主程序
   ├── TrayApp.dll                    # 程序库
   ├── config/
   │   └── appsettings.json           # 主配置文件
   ├── runtimes/                      # 运行时依赖（如为自包含发布）
   ├── PdfiumViewer.Native.x86_64.dll # PDF处理组件
   ├── iTextSharp.dll                # PDF操作库
   └── Microsoft.Office.Interop.Word.dll # Word交互组件
   ```

### 2.2 配置微信文件接收路径 🆕
1. 创建专用监控目录：
   ```
   # 推荐路径（避免中文和空格）
   C:\TrayPrintFiles
   
   # 或用户文档目录
   %USERPROFILE%\Documents\TrayPrintFiles
   ```

2. 配置微信文件保存：
   - 打开微信 → 「设置」→「文件管理」
   - 设置「文件保存位置」为上述监控目录
   - 启用「自动保存接收到的文件」

3. 权限确认：
   - 右键监控目录 → 「属性」→「安全」
   - 确保当前用户具有「完全控制」权限

### 2.3 设置开机启动（推荐） 🆕
1. **方式一：启动文件夹**
   ```bash
   # 打开启动目录
   Win+R → shell:startup
   
   # 创建TrayApp.exe快捷方式到启动目录
   ```

2. **方式二：任务计划程序**（更可靠）
   - 打开「任务计划程序」
   - 创建基本任务 → 「系统启动时」触发
   - 操作设置为启动`TrayApp.exe`
   - 勾选「使用最高权限运行」

## 3. 配置文件详解 🆕

配置文件路径：`config/appsettings.json`，使用文本编辑器修改。

### 3.1 完整配置结构 🆕
```json
{
  "Monitoring": {
    "WatchPath": "C:\\TrayPrintFiles",
    "BatchTimeoutSeconds": 3,
    "FileTypes": [".pdf", ".docx", ".doc", ".jpg", ".png", ".bmp"]
  },
  "PrintSettings": {
    "DefaultCopies": 1,
    "DefaultOrientation": "Portrait", 
    "AutoSelectPrinter": false,
    "AdvancedSettings": {}
  },
  "PrinterManagement": {
    "HiddenPrinters": ["Microsoft Print to PDF", "Fax", "OneNote"],
    "DisplayOrder": "UsageFrequency"
  },
  "TaskHistorySettings": {
    "MaxRecords": 50,
    "EnableHistory": true,
    "StoragePath": "task_history.json"
  },
  "Logging": {
    "LogLevel": "Information",
    "MaxLogFiles": 7,
    "LogDirectory": "logs"
  }
}
```

### 3.2 监控设置（Monitoring）
```json
"Monitoring": {
  "WatchPath": "C:\\TrayPrintFiles",    // 监控目录路径
  "BatchTimeoutSeconds": 3,             // 批量收集超时（秒）
  "FileTypes": [".pdf", ".docx", ".doc", ".jpg", ".png", ".bmp"]  // 🆕支持的文件类型
}
```
- **WatchPath**：必须使用双反斜杠`\\`或正斜杠`/`
- **BatchTimeoutSeconds**：3-10秒合适，过短导致频繁处理，过长影响响应
- **FileTypes**：新增图片格式支持，Word格式包含新旧版本

### 3.3 打印设置（PrintSettings）🆕
```json
"PrintSettings": {
  "DefaultCopies": 1,                   // 默认打印份数
  "DefaultOrientation": "Portrait",     // 默认方向：Portrait(纵向)/Landscape(横向)
  "AutoSelectPrinter": false,           // 是否自动选择默认打印机
  "AdvancedSettings": {                 // 高级设置（可选）
    "PrintQuality": "High",             // 打印质量：Draft/Normal/High
    "ColorMode": "Auto"                 // 颜色模式：Auto/Color/Grayscale
  }
}
```

### 3.4 打印机管理（PrinterManagement）
```json
"PrinterManagement": {
  "HiddenPrinters": ["Microsoft Print to PDF", "Fax", "OneNote"],  // 隐藏打印机
  "DisplayOrder": "UsageFrequency"      // 排序：UsageFrequency/Name/Status
}
```
- **HiddenPrinters**：数组格式，打印机名称完全匹配（区分大小写）
- **DisplayOrder**：推荐"UsageFrequency"（常用优先）

### 3.5 任务历史设置（TaskHistorySettings）🆕
```json
"TaskHistorySettings": {
  "MaxRecords": 50,                     // 最大历史记录数
  "EnableHistory": true,                // 启用历史记录功能
  "StoragePath": "task_history.json"    // 历史文件路径（相对或绝对）
}
```

### 3.6 日志配置（Logging）🆕
```json
"Logging": {
  "LogLevel": "Information",            // 日志级别：Debug/Information/Warning/Error
  "MaxLogFiles": 7,                     // 保留日志文件数量
  "LogDirectory": "logs"                // 日志目录（相对路径）
}
```

## 4. 日常操作指南 🆕

### 4.1 启动与退出
- **启动**：双击 `TrayApp.exe`，系统托盘显示打印机图标
- **退出**：右键托盘图标 → 「退出」（确保数据保存）

### 4.2 统一打印流程 🆕
1. **文件接收**：顾客通过微信发送文件到指定账号
2. **自动收集**：文件保存到监控目录，系统等待3秒收集批量文件
3. **智能转换**：
   - Word文档 → 自动转换为PDF
   - 图片文件 → 自动转换为PDF
   - PDF文件 → 直接处理
4. **打印机选择**：弹出对话框选择目标打印机
5. **统一打印**：使用PDF打印引擎统一处理所有文件
6. **自动归档**：完成后移动原文件到时间戳目录

### 4.3 查看转换和打印状态 🆕
- **实时状态**：托盘图标右键菜单显示当前处理状态
- **历史记录**：左键点击托盘图标查看最近打印记录
- **详细日志**：查看`logs/app_yyyyMMdd.log`文件

### 4.4 处理异常文件
1. **转换失败的文件**：
   - 查看日志确定失败原因
   - 手动转换后重新放入监控目录
   - 或直接拖拽到打印机进行传统打印

2. **打印失败的文件**：
   - 检查打印机状态和连接
   - 确认PDF文件完整性
   - 必要时重启应用程序

## 5. 系统维护 🆕

### 5.1 日志管理
- **日志位置**：用户数据目录`%APPDATA%\TrayPrinterApp\logs\`
- **日志格式**：`app_yyyyMMdd.log`（每日一个文件）
- **自动清理**：超过MaxLogFiles设置的文件会自动删除
- **手动清理**：可定期清理1个月前的日志文件

### 5.2 转换临时文件清理 🆕
- **临时PDF文件**：系统会自动清理转换生成的临时PDF
- **Word进程监控**：如发现残留`WINWORD.exe`进程，及时结束
- **磁盘空间监控**：确保系统盘有足够空间用于临时文件

### 5.3 归档文件管理
- **归档目录**：监控目录下的时间戳文件夹（格式：`yyyyMMddHHmmss`）
- **清理策略**：建议保留最近30天的归档文件
- **批量清理脚本**：
  ```bash
  # PowerShell脚本示例
  $archivePath = "C:\TrayPrintFiles"
  $cutoffDate = (Get-Date).AddDays(-30)
  Get-ChildItem $archivePath | Where-Object { 
      $_.PSIsContainer -and $_.Name -match '^\d{14}$' -and $_.CreationTime -lt $cutoffDate 
  } | Remove-Item -Recurse -Force
  ```

### 5.4 配置文件备份与恢复 🆕
- **备份配置**：
  ```bash
  # 定期备份配置文件
  copy "config\appsettings.json" "config\appsettings_backup_yyyyMMdd.json"
  ```
- **恢复配置**：替换配置文件后重启程序
- **配置验证**：程序启动时会验证配置格式，无效配置会生成警告

### 5.5 程序更新 🆕
1. **备份数据**：
   - 配置文件：`config/appsettings.json`
   - 任务历史：用户数据目录下的`task_history.json`
   - 重要日志文件

2. **更新程序**：
   ```bash
   # 停止当前程序
   # 重新发布最新版本
   dotnet publish src/TrayApp.csproj -c Release -r win-x64 --self-contained -o ./publish
   
   # 复制到目标目录，保留config目录
   ```

3. **验证更新**：
   - 启动程序确认功能正常
   - 测试文件转换和打印功能
   - 检查配置是否正确加载

### 5.6 性能优化建议 🆕
1. **系统资源**：
   - 确保至少2GB可用内存
   - 定期清理系统临时文件
   - 关闭不必要的后台程序

2. **Office优化**：
   - 禁用Word启动画面和模板加载
   - 定期更新Office到最新版本
   - 清理Word最近使用文档列表

3. **监控目录优化**：
   - 避免在监控目录存放大量历史文件
   - 使用SSD硬盘提升I/O性能
   - 定期整理磁盘碎片

---

## 🚀 高级配置

### 多打印机环境配置 🆕
```json
"PrinterProfiles": {
  "HighVolume": {
    "PrinterNames": ["HP LaserJet 1", "HP LaserJet 2"],
    "DefaultSettings": {
      "Copies": 1,
      "Quality": "Draft"
    }
  },
  "HighQuality": {
    "PrinterNames": ["Canon ImageRunner"],
    "DefaultSettings": {
      "Quality": "High",
      "ColorMode": "Color"
    }
  }
}
```

### 网络打印机支持 🆕
- 确保网络打印机驱动正确安装
- 配置中使用完整的网络打印机名称
- 考虑网络延迟对打印响应的影响

**💡 部署提示**: 统一PDF打印架构显著简化了部署复杂度，无需配置多个外部打印程序，只需确保.NET 8和Office正确安装即可实现全格式文件的自动化打印处理。