# 打印店自动打印系统 - 常见问题排查手册

## 目录
1. [打印机相关问题](#1-打印机相关问题)
2. [文件处理问题](#2-文件处理问题)
3. [程序运行问题](#3-程序运行问题)
4. [日志查看指南](#4-日志查看指南)
5. [紧急恢复方案](#5-紧急恢复方案)

## 1. 打印机相关问题

### 1.1 打印机选择界面不显示目标打印机
**可能原因**：
- 打印机被配置过滤
- 打印机未正确安装
- 打印机名称包含特殊字符

**排查步骤**：
1. 检查配置文件`appsettings.json`的`HiddenPrinters`项，确认目标打印机未被列出
   ```json
   "PrinterManagement": {
     "HiddenPrinters": ["Microsoft Print to PDF", "Fax"]  // 确保目标打印机不在此列表
   }
   ```
2. 打开「控制面板」→「设备和打印机」，确认目标打印机状态为「就绪」
3. 如打印机名称包含中文或特殊字符，尝试重命名为纯英文（如"FrontPrinter"）

### 1.2 选择打印机后无反应
**可能原因**：
- 打印机驱动异常
- 打印机处于离线状态
- 打印队列堵塞

**排查步骤**：
1. 打开「控制面板」→「设备和打印机」，右键目标打印机→选择「查看现在正在打印什么」
2. 如有堵塞任务，点击「打印机」→「取消所有文档」
3. 右键目标打印机→选择「设为默认打印机」，尝试直接打印测试页
4. 重启打印机，等待30秒后再次尝试

### 1.3 打印机打印乱码或格式错误
**可能原因**：
- 打印程序参数错误
- 文件格式损坏
- 打印程序版本不兼容

**解决方案**：
1. 检查配置文件中对应文件类型的打印参数：
   ```json
   ".pdf": {
     "Arguments": "/t \"{FilePath}\" \"{PrinterName}\""  // 确保参数正确
   }
   ```
2. 手动双击文件确认能正常打开（如无法打开则文件损坏，需重新接收）
3. 更新打印程序到最新版本（如Adobe Acrobat、Microsoft Office）

## 2. 文件处理问题

### 2.1 微信接收文件后系统无反应
**可能原因**：
- 监控目录配置错误
- 文件类型未被监控
- 文件未完全接收

**排查步骤**：
1. 确认微信文件保存路径与配置中的`WatchPath`一致：
   ```json
   "Monitoring": {
     "WatchPath": "C:\\WeChatPrintFiles"  // 必须与微信设置一致
   }
   ```
2. 检查文件扩展名是否在`FileTypes`列表中：
   ```json
   "FileTypes": [".pdf", ".docx", ".jpg", ".png", ".doc"]
   ```
3. 查看文件大小是否稳定（微信传输中文件会临时命名为`~xxx.tmp`，传输完成后恢复原名）

### 2.2 文件提示"打印失败"
**可能原因**：
- 打印程序路径配置错误
- 打印程序未安装或损坏
- 文件被其他程序锁定

**排查步骤**：
1. 检查配置文件中对应文件类型的`ExecutorPath`是否正确：
   ```json
   ".pdf": {
     "ExecutorPath": "C:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe"
   }
   ```
2. 手动打开打印程序（如Adobe Acrobat），确认能正常启动
3. 尝试将文件复制到桌面，手动双击打开并打印，检查是否正常

### 2.3 打印后文件未归档
**可能原因**：
- 权限不足
- 磁盘空间不足
- 文件名包含特殊字符

**解决方案**：
1. 右键监控目录→「属性」→「安全」→确保当前用户有「写入」权限
2. 检查磁盘空间，确保至少有100MB可用空间
3. 重命名包含特殊字符（如`/\:*?"<>|`）的文件，替换为下划线`_`

## 3. 程序运行问题

### 3.1 程序启动后托盘无图标
**可能原因**：
- .NET Framework未安装
- 程序被安全软件拦截
- 系统托盘图标被隐藏

**排查步骤**：
1. 安装.NET Framework 4.8（下载地址：https://dotnet.microsoft.com/download/dotnet-framework/net48）
2. 打开杀毒软件→「隔离区」，检查是否有`TrayApp.exe`被拦截，添加信任
3. 点击系统托盘→「显示隐藏的图标」，将打印机图标固定到任务栏

### 3.2 程序频繁崩溃
**可能原因**：
- 配置文件格式错误
- 监控目录包含大量文件
- 系统资源不足

**解决方案**：
1. 替换配置文件：删除`config/appsettings.json`，重启程序会生成默认配置
2. 清理监控目录：将历史文件移至其他位置（保留最近24小时文件即可）
3. 关闭其他占用资源的程序（如视频播放器、大型游戏等）

### 3.3 托盘图标不显示历史页码
**可能原因**：
- 历史记录文件损坏
- 权限不足无法写入
- 程序未正常退出导致记录丢失

**排查步骤**：
1. 删除`task_history.json`文件，重启程序会生成新的历史记录文件
2. 右键程序目录→「属性」→「安全」，确保当前用户有「写入」权限
3. 始终通过右键托盘图标→「退出」来关闭程序，避免强制结束进程

## 4. 日志查看指南

日志文件路径：`app.log`，使用记事本打开即可查看。

### 4.1 关键日志识别
- **成功日志**：`[INFO] 文件打印成功: xxx.pdf`
- **错误日志**：`[ERROR] 打印失败: xxx.docx`（包含具体错误原因）
- **配置日志**：`[INFO] 任务历史配置: 最大记录数=5`（启动时输出，确认配置是否生效）

### 4.2 常见错误日志示例及解决
```
[ERROR] 打印程序未找到: C:\Program Files\Adobe\Acrobat DC\Acrobat\Acrobat.exe
```
→ 解决方案：检查Adobe Acrobat是否安装在该路径，或更新配置文件中的`ExecutorPath`

```
[ERROR] 文件不存在: C:\WeChatPrintFiles\test.pdf
```
→ 解决方案：确认文件是否被手动删除，或微信传输是否中断

## 5. 紧急恢复方案

当系统完全无法使用时，可采用以下临时方案保障业务运行：

### 方案一：手动打印流程
1. 打开微信文件保存目录（如`C:\WeChatPrintFiles`）
2. 按文件类型分类处理：
   - PDF文件：右键→「打开方式」→「Adobe Acrobat」→按`Ctrl+P`打印
   - Word文件：右键→「打开方式」→「Word」→按`Ctrl+P`打印
   - 图片文件：右键→「打开方式」→「画图」→按`Ctrl+P`打印

### 方案二：重置系统配置
1. 关闭程序，备份以下文件：
   - `config/appsettings.json`（配置文件）
   - `task_history.json`（历史记录）
2. 删除原程序目录，重新解压程序包
3. 手动恢复备份的配置文件（如有必要）

### 方案三：联系技术支持
如以上方案均无法解决问题，请收集以下信息联系技术支持：
- 错误发生时间
- `app.log`完整日志文件
- 问题复现步骤描述
- 截图（如打印机选择界面、错误提示框等）