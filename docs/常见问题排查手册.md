# TrayPrinterApp - 常见问题排查手册（统一PDF架构版）

## 目录
1. [打印系统相关问题](#1-打印系统相关问题)
2. [文件转换问题](#2-文件转换问题)
3. [程序运行问题](#3-程序运行问题)
4. [日志查看指南](#4-日志查看指南)
5. [紧急恢复方案](#5-紧急恢复方案)

## 1. 打印系统相关问题

### 1.1 打印机选择界面不显示目标打印机
**可能原因**：
- 打印机被配置过滤
- 打印机未正确安装
- 打印机名称包含特殊字符

**排查步骤**：
1. 检查配置文件`config/appsettings.json`的`HiddenPrinters`项，确认目标打印机未被列出
   ```json
   "PrinterManagement": {
     "HiddenPrinters": ["Microsoft Print to PDF", "Fax"]  // 确保目标打印机不在此列表
   }
   ```
2. 打开「控制面板」→「设备和打印机」，确认目标打印机状态为「就绪」
3. 如打印机名称包含中文或特殊字符，尝试重命名为纯英文（如"FrontPrinter"）

### 1.2 PDF打印失败或无响应 🆕
**可能原因**：
- PdfiumViewer组件异常
- PDF文件损坏或格式不支持
- 打印机驱动问题

**排查步骤**：
1. 检查PDF文件完整性：手动双击PDF文件确认能正常打开
2. 查看应用日志中的详细错误信息：
   ```
   [ERROR] PDF打印失败: xxx.pdf - 详细错误信息
   ```
3. 尝试更换其他PDF文件测试，确认是文件问题还是系统问题
4. 重启应用程序，清理可能的资源占用

### 1.3 打印质量异常（模糊、缺页等） 🆕
**可能原因**：
- PDF转换质量设置过低
- 打印机分辨率配置问题
- 源文件质量问题

**解决方案**：
1. 检查打印设置配置：
   ```json
   "PrintSettings": {
     "DefaultCopies": 1,
     "DefaultOrientation": "Portrait"
   }
   ```
2. 在打印机属性中调整打印质量为「高质量」或「最佳」
3. 对于图片转PDF，检查原图片分辨率是否足够

## 2. 文件转换问题 🆕

### 2.1 Word文档转换失败
**可能原因**：
- Microsoft Office未安装或版本不兼容
- Word文档受密码保护
- Office进程残留导致冲突

**排查步骤**：
1. 确认Microsoft Office安装状态：
   - 手动打开Word程序确认能正常启动
   - 尝试手动打开目标Word文档
2. 检查任务管理器中是否有残留的`WINWORD.exe`进程，如有请结束
3. 查看日志文件中的转换错误详情：
   ```
   [ERROR] Word转PDF失败: xxx.docx - COM组件异常
   ```

**解决方案**：
1. 重新安装或修复Microsoft Office
2. 如文档受保护，先手动解除密码保护
3. 重启计算机清理Office进程状态

### 2.2 图片转换质量差或失败
**可能原因**：
- 图片格式不支持（如损坏的JPEG）
- 图片尺寸过大导致内存不足
- iTextSharp组件异常

**排查步骤**：
1. 检查支持的图片格式：JPG, PNG, BMP, TIFF
2. 查看图片文件大小和分辨率：
   - 超大图片（>50MB）可能导致转换超时
   - 异常分辨率可能导致页面布局错误
3. 尝试使用其他图片编辑软件重新保存图片

**解决方案**：
1. 使用标准图片编辑软件重新保存问题图片
2. 对超大图片进行适当压缩（推荐<10MB）
3. 确保图片文件完整性，无损坏

### 2.3 转换过程卡住或超时 🆕
**可能原因**：
- 源文件过大
- Office组件响应异常
- 系统资源不足

**解决方案**：
1. 增加转换超时时间（如有配置选项）
2. 关闭其他占用内存的程序
3. 分批处理大文件，避免同时转换多个大文档
4. 重启应用程序清理内存

## 3. 程序运行问题

### 3.1 程序启动后托盘无图标
**可能原因**：
- .NET 8 Runtime未安装 🆕
- 程序被安全软件拦截
- 系统托盘图标被隐藏

**排查步骤**：
1. 确认.NET 8 Runtime安装：
   ```bash
   # 在命令行中执行
   dotnet --version
   # 应该显示8.x.x版本号
   ```
2. 打开杀毒软件→「隔离区」，检查是否有`TrayApp.exe`被拦截，添加信任
3. 点击系统托盘→「显示隐藏的图标」，将打印机图标固定到任务栏

### 3.2 程序频繁崩溃或异常退出 🆕
**可能原因**：
- 配置文件格式错误
- NuGet依赖包版本冲突
- 内存泄漏导致资源耗尽

**解决方案**：
1. 检查配置文件格式：
   ```json
   // 确保appsettings.json格式正确，无语法错误
   {
     "Monitoring": {
       "WatchPath": "C:\\WeChatPrintFiles"
     }
   }
   ```
2. 重置配置到默认状态：删除`config/appsettings.json`，重启程序会生成默认配置
3. 查看Windows事件查看器中的应用程序错误日志
4. 检查系统内存使用情况，确保可用内存充足

### 3.3 批量文件处理性能差 🆕
**可能原因**：
- 同时处理文件数量过多
- 转换过程串行执行效率低
- 系统I/O性能瓶颈

**优化方案**：
1. 调整批量处理配置：
   ```json
   "Monitoring": {
     "BatchTimeoutSeconds": 5  // 增加批量收集时间，减少频繁处理
   }
   ```
2. 避免监控目录中累积大量历史文件
3. 关闭不必要的后台程序，释放系统资源
4. 考虑使用SSD硬盘提升I/O性能

### 3.4 托盘图标功能异常
**可能原因**：
- 任务历史数据损坏
- UI线程阻塞
- 事件处理异常

**排查步骤**：
1. 删除任务历史文件，重新开始记录：
   - 删除用户数据目录下的`task_history.json`
   - 重启程序会创建新的历史文件
2. 检查是否有长时间运行的任务阻塞UI线程
3. 查看日志中的UI相关异常信息

## 4. 日志查看指南 🆕

### 4.1 日志文件位置
- **主日志**：用户数据目录下的`logs/app_yyyyMMdd.log`
- **用户数据目录**：通常为`%APPDATA%\TrayPrinterApp\` 或 `%PROGRAMDATA%\TrayPrinterApp\`

### 4.2 关键日志识别
- **转换成功**：`[INFO] 文件转换成功: xxx.docx -> xxx.pdf`
- **打印成功**：`[INFO] PDF打印成功: xxx.pdf`
- **转换错误**：`[ERROR] 文件转换失败: xxx.docx`（包含具体错误原因）
- **打印错误**：`[ERROR] PDF打印失败: xxx.pdf`（包含具体错误原因）
- **配置加载**：`[INFO] 配置文件已加载: config/appsettings.json`

### 4.3 常见错误日志示例及解决
```
[ERROR] Word转PDF转换失败: test.docx - 未安装Microsoft Word
```
→ 解决方案：安装Microsoft Office或使用其他Word兼容软件

```
[ERROR] 图片转PDF失败: image.jpg - 文件格式不受支持
```
→ 解决方案：检查图片文件完整性，或转换为标准JPG/PNG格式

```
[ERROR] PDF打印失败: document.pdf - 找不到指定的打印机
```
→ 解决方案：确认打印机名称正确，检查打印机连接状态

## 5. 紧急恢复方案

当统一PDF打印系统完全无法使用时，可采用以下临时方案：

### 方案一：手动转换+打印流程 🆕
1. **Word文档处理**：
   - 手动打开Word文档
   - 点击「文件」→「另存为」→选择PDF格式
   - 右键生成的PDF文件→「打印」

2. **图片文件处理**：
   - 使用系统自带「画图」程序打开图片
   - 按`Ctrl+P`直接打印，或先保存为PDF再打印

3. **PDF文件处理**：
   - 使用Adobe Reader或浏览器打开PDF
   - 按`Ctrl+P`直接打印

### 方案二：重置应用程序 🆕
1. 完全卸载当前程序：
   - 关闭TrayApp进程
   - 删除程序安装目录
   - 清理用户数据目录（`%APPDATA%\TrayPrinterApp\`）

2. 重新部署程序：
   ```bash
   # 重新发布程序
   dotnet publish src/TrayApp.csproj -c Release -o ./publish
   ```

3. 恢复必要配置：
   - 重新配置微信文件保存路径
   - 设置目标打印机
   - 调整批量处理参数

### 方案三：降级到基础功能
如统一PDF架构出现问题，可临时禁用转换功能：
1. 修改配置文件，仅监控PDF文件：
   ```json
   "Monitoring": {
     "FileTypes": [".pdf"]  // 仅处理PDF，跳过转换
   }
   ```
2. 手动将Word/图片文件转换为PDF后再放入监控目录
3. 等待问题修复后恢复完整功能

### 方案四：联系技术支持 🆕
如以上方案均无法解决问题，请收集以下信息：
- 完整的日志文件（`logs/app_yyyyMMdd.log`）
- 问题发生时的具体操作步骤
- 系统环境信息：
  - Windows版本
  - .NET版本（`dotnet --version`）
  - Office版本（如涉及Word转换）
- 错误截图或异常堆栈信息

---

## 📞 技术支持信息

- **GitHub Issues**: [https://github.com/quying2024/TrayPrinterApp/issues](https://github.com/quying2024/TrayPrinterApp/issues)
- **项目文档**: 参考项目根目录下的各类技术文档
- **调试指南**: [docs/VS2022调试指南.md](docs/VS2022调试指南.md)

**💡 提示**: 统一PDF打印架构相比传统多程序调用方式更加稳定可靠，大多数问题都与文件转换环节相关。建议优先检查Office安装状态和PDF处理组件