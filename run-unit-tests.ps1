# ???????????
# ?????????????

Write-Host "?? ???? TrayPrinterApp ????" -ForegroundColor Green

try {
    Write-Host "?? ??????..." -ForegroundColor Yellow
    
    # ????????????
    $testProject = "tests\TrayApp.Tests.csproj"
    if (!(Test-Path $testProject)) {
        Write-Host "? ???????: $testProject" -ForegroundColor Red
        exit 1
    }
    
    Write-Host "? ??????" -ForegroundColor Green
    
    # ?????????
    Write-Host "?? ???????..." -ForegroundColor Yellow
    $mainProject = "src\TrayApp.csproj"
    if (!(Test-Path $mainProject)) {
        Write-Host "? ??????: $mainProject" -ForegroundColor Red
        exit 1
    }
    
    Write-Host "? ?????" -ForegroundColor Green
    
    # ?????????
    Write-Host "?? ????????..." -ForegroundColor Yellow
    $buildResult = dotnet build $mainProject --configuration Debug --verbosity quiet
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "? ???????" -ForegroundColor Green
    } else {
        Write-Host "?? ??????????????" -ForegroundColor Yellow
    }
    
    # ????????
    Write-Host "?? ????????..." -ForegroundColor Yellow
    $testBuildResult = dotnet build $testProject --configuration Debug --verbosity quiet
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "? ????????" -ForegroundColor Green
    } else {
        Write-Host "?? ?????????" -ForegroundColor Yellow
    }
    
    # ??????????????????????
    Write-Host "?? ????????..." -ForegroundColor Yellow
    Write-Host "??????????????" -ForegroundColor Gray
    
    # ??????????
    $env:DOTNET_TEST_TIMEOUT = "30000" # 30???
    
    # ????????????????????????
    dotnet test $testProject --configuration Debug --verbosity normal --filter "FullyQualifiedName!~Integration" --logger "console;verbosity=detailed" --no-build
    
    $testExitCode = $LASTEXITCODE
    
    if ($testExitCode -eq 0) {
        Write-Host "? ????????" -ForegroundColor Green
    } else {
        Write-Host "?? ????????? (???: $testExitCode)" -ForegroundColor Yellow
        Write-Host "????????????????????????" -ForegroundColor Gray
    }
    
    Write-Host ""
    Write-Host "?? ????:" -ForegroundColor Cyan
    Write-Host "• ?????: $(if ($buildResult) { '? ??' } else { '?? ????' })" -ForegroundColor Gray
    Write-Host "• ??????: $(if ($testBuildResult) { '? ??' } else { '?? ????' })" -ForegroundColor Gray
    Write-Host "• ??????: $(if ($testExitCode -eq 0) { '? ??' } else { '?? ????' })" -ForegroundColor Gray
    
    Write-Host ""
    Write-Host "?? ??:" -ForegroundColor Yellow
    Write-Host "- PdfiumViewer.Core ????DLL????????????" -ForegroundColor Gray
    Write-Host "- ??????????????Office??????" -ForegroundColor Gray
    Write-Host "- ????????????????????" -ForegroundColor Gray
    
} catch {
    Write-Host "? ?????????: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "??????????????????" -ForegroundColor Gray
    exit 1
}

Write-Host ""
Write-Host "?? ?????:" -ForegroundColor Green
Write-Host "1. ?????????????????" -ForegroundColor Gray
Write-Host "2. ?????????????????" -ForegroundColor Gray  
Write-Host "3. ??????????????????" -ForegroundColor Gray